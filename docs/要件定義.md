# DLsite データ収集システム - 要件定義

## 概要

DLsiteの作品情報（お気に入り数・販売数）を自動収集し、スプレッドシートに記録するシステム。

---

## 既存システムの問題点

### 現在の構成
- **AWS Lambda**: DOMを取得
- **GAS**: DOMを整形・スプレッドシートに転記

### 発生している問題
- 新着取得が失敗することがある
- 数字（お気に入り数・販売数）が取得できない場合がある
- AWS + GAS の2段構成による複雑さ

---

## 要件一覧

### 1. サークルページからの新着作品検出

| 項目 | 内容 |
|------|------|
| 対象 | 監視対象サークルの作品一覧ページ |
| 取得タイミング | 毎日 16:00（予告開始時間） |
| 取得データ | 作品ID, タイトル, URL, サークル名, 予告開始日 |
| 処理 | 新規作品をスプレッドシートに追加 |

**監視対象サークル例:**
- スタジオりふれぼ
- 生ハメ堕ち部★LACK
- 狂愛プレジャー《執着×吐息》
- 蜜愛ディザイア
- 濃蜜ラブルージュCOMICS+
- りふれぼコミック

---

### 2. 新着登場日の翌朝お気に入り数取得

| 項目 | 内容 |
|------|------|
| 対象 | 前日16時に予告開始した作品 |
| 取得タイミング | 毎日 10:00 JST（予告開始から約18時間後） |
| 取得データ | 初動お気に入り数 |
| 記録先 | 「予告開始fav」列 |

**ロジック:**
```
IF 予告開始日 == 昨日 AND 予告開始fav が空
THEN お気に入り数を取得して記録
```

---

### 3. 発売前日夜のお気に入り数取得

| 項目 | 内容 |
|------|------|
| 対象 | 翌日が発売日の作品 |
| 取得タイミング | 毎日 23:00 JST |
| 取得データ | 発売直前お気に入り数 |
| 記録先 | 「発売前日fav」列 |

**ロジック:**
```
IF 発売日 == 明日
THEN お気に入り数を取得して記録
```

---

### 4. 発売日の販売本数取得

| 項目 | 内容 |
|------|------|
| 対象 | 発売開始した作品 |
| 取得タイミング | 毎日 10:00 JST（発売から約10時間後） |
| 取得データ | 累計販売数 |
| 記録先 | 「販売件数累計_N日目」列 |

**取得日:**
- 発売1日目（発売日翌朝）
- 発売2日目〜7日目
- 発売14日目
- 発売21日目
- 発売29日目（4週目）

---

## データ構造

### スプレッドシートのカラム

| 列 | 項目名 | 説明 |
|----|--------|------|
| A | サークル名 | 作品のサークル/レーベル名 |
| B | タイトル | 作品タイトル |
| C | URL | DLsite作品ページURL |
| D | 本体価格(税抜) | 販売価格 |
| E | 予告開始日 | 予告が公開された日 |
| F | 予告開始曜日 | 予告開始日の曜日 |
| G | 発売日 | 発売予定日/発売日 |
| H | 初動お気に入り数 | 予告開始翌朝のお気に入り数 |
| I | 発売前日fav | 発売前日夜のお気に入り数 |
| J | 販売件数累計_1日目 | 発売1日目の累計販売数 |
| K | 販売件数累計_2日目 | 発売2日目の累計販売数 |
| ... | ... | ... |
| S | 販売件数累計_29日目 | 発売29日目の累計販売数 |

---

## API/取得元

### 1. DLsite API（お気に入り数・販売数）
```
https://www.dlsite.com/maniax/product/info/ajax?product_id=RJ123456
```

**レスポンス例:**
```json
{
  "RJ123456": {
    "work_name": "作品タイトル",
    "wishlist_count": 1234,
    "dl_count": 5678,
    "is_ana": false
  }
}
```

### 2. サークルページ（作品一覧）
```
https://www.dlsite.com/maniax/circle/profile/=/maker_id/RG12345.html
```

### 3. 発売予告ページ
```
https://www.dlsite.com/maniax/announce/list/day
```

---

## スケジュール一覧

| 時刻 (JST) | 処理 |
|------------|------|
| 10:00 | 新着登場日翌朝のお気に入り数取得 |
| 10:00 | 発売日の販売本数取得 |
| 16:00 | サークルページから新着作品検出 |
| 23:00 | 発売前日夜のお気に入り数取得 |

---

## 実装方針の選択肢

### 方針A: GitHub Actions のみ
- **メリット**: 無料、シンプル
- **デメリット**: スケジュール精度が±15分程度

### 方針B: GAS (Google Apps Script) のみ
- **メリット**: スプレッドシートと直接連携、トリガー設定が柔軟
- **デメリット**: 実行時間制限（6分/回）

### 方針C: AWS Lambda + EventBridge
- **メリット**: 高精度なスケジュール、長時間実行可能
- **デメリット**: コスト、複雑さ、現在問題が発生中

### 推奨: 方針B (GAS) または 方針A (GitHub Actions)
- DLsite APIが直接使える場合はGASでシンプルに実装
- スクレイピングが必要な場合はGitHub Actions

---

## 既存プロジェクト参照

| プロジェクト | 概要 |
|-------------|------|
| GAS_DLsite_SALESandFAV | 販売数・お気に入り数取得（カテゴリ別） |
| GAS_Illustrator_Notification | 閾値超過時の通知 |
| GAS_N_Ranking_Label | 発売予告作品の追跡 |
| GAS_RANKING_LABEL | サークル監視・新規作品追加 |
| AWS_DLsite_fav_checker | AWS+GAS連携 |

---

## 次のステップ

1. [ ] 実装方針の決定（GAS or GitHub Actions）
2. [ ] 監視対象サークルリストの確定
3. [ ] スプレッドシート構造の確定
4. [ ] 基本機能の実装
5. [ ] スケジュール設定
6. [ ] テスト・運用開始
